version: 0.2

phases:
  pre_build:
    commands:
      - echo "Install Hadolint..."
      - wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.6.0/hadolint-Linux-x86_64
      - chmod +x hadolint
      - mv hadolint /usr/local/bin/
      - echo "Hadolint installed."
      - echo "Installing kubectl..."
      - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/
      - echo "kubectl installed."
      - echo "Install AWS CLI..."
      - curl "https://d1vvhvl2y92vvt.cloudfront.net/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      - unzip awscliv2.zip
      - sudo ./aws/install
      - echo "AWS CLI installed."

  build:
    commands:
      - echo "Logging into ECR..."
      - aws ecr get-login-password --region eu-central-1 | docker login --username AWS --password-stdin 716308103419.dkr.ecr.eu-central-1.amazonaws.com
      - echo "Configure AWS CLI..."
      - aws configure set aws_access_key_id AKIA2NR2KID55VKHZC5X
      - aws configure set aws_secret_access_key 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
      - aws configure set default.region eu-central-1
      - echo "AWS CLI configured."

  post_build:
    commands:
      - docker build -t hello-python-flask .
      - docker tag hello-python-flask:latest 716308103419.dkr.ecr.eu-central-1.amazonaws.com/hello-python-flask:latest
      - docker push 716308103419.dkr.ecr.eu-central-1.amazonaws.com/hello-python-flask:latest
      - aws eks update-kubeconfig --region eu-central-1 --name CI-CD-PipeLine --kubeconfig ~/kubeconfig
      - export KUBECONFIG=~/kubeconfig
      - cat ~/kubeconfig
      - kubectl --kubeconfig ~/kubeconfig get nodes
      - kubectl --kubeconfig ~/kubeconfig apply -f deployment.yaml
      - kubectl --kubeconfig ~/kubeconfig apply -f service.yaml